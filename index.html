<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Al Bourakh - Administration Unifi√©e v6.1</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; }
        .header { background: linear-gradient(135deg, #00A854, #FECB00); color: white; padding: 30px; border-radius: 15px; margin-bottom: 30px; box-shadow: 0 8px 25px rgba(0,0,0,0.2); position: relative; }
        .header h1 { font-size: 2.2em; display: flex; align-items: center; gap: 15px; }
        .header p { margin-top: 10px; opacity: 0.9; }
        .logout-btn { position: absolute; top: 30px; right: 30px; background: rgba(255,255,255,0.2); color: white; border: none; padding: 12px 25px; border-radius: 8px; cursor: pointer; font-size: 1em; transition: all 0.3s; }
        .logout-btn:hover { background: rgba(255,255,255,0.3); }
        
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .tab-btn { padding: 12px 25px; border: none; border-radius: 10px; font-size: 1em; font-weight: 600; cursor: pointer; transition: all 0.3s; background: white; color: #333; box-shadow: 0 2px 8px rgba(0,0,0,0.1); display: flex; align-items: center; gap: 8px; }
        .tab-btn.active { background: linear-gradient(135deg, #00A854, #FECB00); color: white; }
        .tab-btn:hover { transform: translateY(-2px); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 25px; }
        .stat-card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); display: flex; align-items: center; gap: 15px; }
        .stat-icon { width: 50px; height: 50px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.5em; }
        .stat-icon.green { background: #d4edda; color: #00A854; }
        .stat-icon.blue { background: #cce5ff; color: #004085; }
        .stat-icon.orange { background: #fff3cd; color: #856404; }
        .stat-icon.red { background: #f8d7da; color: #721c24; }
        .stat-icon.purple { background: #e2d9f3; color: #6f42c1; }
        .stat-icon.teal { background: #d1ecf1; color: #0c5460; }
        .stat-info h3 { font-size: 1.8em; color: #333; margin-bottom: 3px; }
        .stat-info p { color: #666; font-size: 0.9em; }
        .stat-count { background: #e8f5e9; color: #00A854; padding: 4px 12px; border-radius: 15px; font-size: 0.85em; font-weight: bold; margin-top: 5px; }
        
        .section, .main-content { background: white; border-radius: 15px; padding: 25px; margin-bottom: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .section-header, .action-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #f0f0f0; flex-wrap: wrap; gap: 15px; }
        .section-title { font-size: 1.3em; font-weight: bold; color: #333; display: flex; align-items: center; gap: 10px; }
        
        .search-box { flex: 1; max-width: 350px; position: relative; }
        .search-box input { width: 100%; padding: 12px 45px 12px 20px; border: 2px solid #ddd; border-radius: 10px; font-size: 1em; }
        .search-box i { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: #999; }
        
        .filters { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
        .filter-btn { padding: 8px 16px; border: 2px solid #ddd; border-radius: 8px; background: white; cursor: pointer; font-size: 0.9em; transition: all 0.3s; display: flex; align-items: center; gap: 6px; }
        .filter-btn:hover { border-color: #00A854; }
        .filter-btn.active { background: #00A854; color: white; border-color: #00A854; }
        
        .btn { padding: 10px 20px; border: none; border-radius: 8px; font-size: 0.95em; font-weight: 600; cursor: pointer; transition: all 0.3s; display: inline-flex; align-items: center; gap: 6px; }
        .btn-primary { background: linear-gradient(135deg, #00A854, #FECB00); color: white; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,168,84,0.3); }
        .btn-success, .btn-validate { background: #28a745; color: white; }
        .btn-danger, .btn-reject { background: #E30613; color: white; }
        .btn-secondary, .btn-refresh { background: #6c757d; color: white; }
        .btn-info, .btn-view { background: #17a2b8; color: white; }
        .btn-warning, .btn-edit { background: #ffc107; color: #333; }
        .btn-icon { width: 32px; height: 32px; padding: 0; display: flex; align-items: center; justify-content: center; border-radius: 6px; font-size: 0.85em; }
        .btn-delete { background: #E30613; color: white; }
        .btn-accept { background: #28a745; color: white; }
        
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        thead { background: #f8f9fa; }
        th { padding: 12px; text-align: left; font-weight: 600; color: #333; border-bottom: 2px solid #dee2e6; font-size: 0.9em; }
        td { padding: 12px; border-bottom: 1px solid #f0f0f0; font-size: 0.9em; }
        tbody tr:hover { background: #f8f9fa; }
        
        .status-badge { padding: 5px 10px; border-radius: 20px; font-size: 0.8em; font-weight: 600; display: inline-block; }
        .status-pending, .status-en_attente { background: #fff3cd; color: #856404; }
        .status-validated, .status-completed, .status-acceptee, .status-disponible { background: #d4edda; color: #155724; }
        .status-rejected, .status-refusee, .status-hors_ligne, .status-hors-ligne { background: #f8d7da; color: #721c24; }
        .status-en_course, .status-en-course, .status-active { background: #cce5ff; color: #004085; }
        
        .type-badge { padding: 4px 8px; border-radius: 15px; font-size: 0.75em; font-weight: 600; display: inline-block; }
        .type-with-vehicle { background: #d1ecf1; color: #0c5460; }
        .type-without-vehicle { background: #fff3cd; color: #856404; }
        
        .amount-highlight { font-size: 1.2em; font-weight: bold; }
        .amount-credit { color: #00A854; }
        .amount-debit { color: #E30613; }
        .action-buttons { display: flex; gap: 5px; flex-wrap: wrap; }
        
        .albourakh-main-account { background: linear-gradient(135deg, #1e3a8a, #3b82f6); color: white; padding: 25px; border-radius: 15px; margin-bottom: 30px; box-shadow: 0 8px 25px rgba(0,0,0,0.2); }
        .albourakh-main-account h2 { font-size: 1.4em; margin-bottom: 15px; display: flex; align-items: center; gap: 10px; }
        .albourakh-account-number { font-size: 2em; font-weight: bold; margin-bottom: 15px; letter-spacing: 2px; }
        .albourakh-instructions { background: rgba(255,255,255,0.15); padding: 15px; border-radius: 10px; }
        .albourakh-instructions h3 { font-size: 1em; margin-bottom: 10px; }
        .albourakh-instructions ul { margin-left: 20px; }
        .albourakh-instructions li { margin-bottom: 8px; line-height: 1.5; }
        
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; align-items: center; justify-content: center; padding: 20px; overflow-y: auto; }
        .modal.active { display: flex; }
        .modal-content { background: white; max-width: 900px; width: 100%; border-radius: 15px; max-height: 90vh; overflow-y: auto; }
        .modal-header { background: linear-gradient(135deg, #00A854, #FECB00); color: white; padding: 20px; border-radius: 15px 15px 0 0; display: flex; justify-content: space-between; align-items: center; }
        .modal-header h2 { font-size: 1.4em; }
        .modal-close { background: rgba(255,255,255,0.2); border: none; color: white; width: 35px; height: 35px; border-radius: 50%; cursor: pointer; font-size: 1.2em; }
        .modal-body { padding: 25px; }
        
        .info-section { background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 15px; }
        .info-section h4 { color: #00A854; margin-bottom: 10px; display: flex; align-items: center; gap: 8px; }
        .info-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; }
        .info-item { padding: 8px 0; }
        .info-item label { color: #666; font-size: 0.85em; display: block; }
        .info-item span { font-weight: 600; color: #333; }
        
        .validation-instructions { background: linear-gradient(135deg, #fef3c7, #fde68a); border: 2px solid #f59e0b; padding: 20px; border-radius: 12px; margin-bottom: 20px; }
        .validation-instructions h4 { color: #92400e; margin-bottom: 15px; display: flex; align-items: center; gap: 10px; }
        .validation-instructions ol { margin-left: 20px; color: #78350f; }
        .validation-instructions li { margin-bottom: 10px; line-height: 1.6; }
        .validation-instructions strong { color: #b45309; }
        
        .docs-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px; }
        .doc-card { border: 2px solid #e0e0e0; border-radius: 10px; overflow: hidden; transition: all 0.3s; }
        .doc-card:hover { border-color: #00A854; transform: translateY(-3px); }
        .doc-card img { width: 100%; height: 150px; object-fit: cover; cursor: pointer; }
        .doc-card .doc-label { padding: 10px; background: #f8f9fa; text-align: center; font-weight: 600; font-size: 0.85em; }
        .doc-card a { display: block; padding: 10px; background: #00A854; color: white; text-align: center; text-decoration: none; font-size: 0.85em; }
        
        .alert-box { background: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; border-radius: 8px; margin-bottom: 20px; display: flex; align-items: start; gap: 10px; }
        .alert-box.info { background: #d1ecf1; border-left-color: #17a2b8; }
        .alert-box.danger { background: #f8d7da; border-left-color: #dc3545; }
        .alert-box i { font-size: 1.5em; color: #856404; }
        .alert-box.info i { color: #0c5460; }
        .alert-box.danger i { color: #721c24; }
        
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #333; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 1em; }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: #00A854; }
        
        .toast { position: fixed; top: 20px; right: 20px; background: white; padding: 15px 20px; border-radius: 10px; box-shadow: 0 8px 25px rgba(0,0,0,0.2); z-index: 9999; animation: slideIn 0.3s; max-width: 350px; }
        @keyframes slideIn { from { transform: translateX(400px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .toast.success { border-left: 4px solid #00A854; }
        .toast.error { border-left: 4px solid #E30613; }
        .toast.info { border-left: 4px solid #2196F3; }
        
        .loading { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; align-items: center; justify-content: center; flex-direction: column; }
        .loading.active { display: flex; }
        .spinner { width: 60px; height: 60px; border: 6px solid rgba(255,255,255,0.3); border-top-color: #FECB00; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-text { color: white; font-size: 1.2em; margin-top: 20px; }
        
        .login-container { max-width: 450px; margin: 80px auto; background: white; padding: 40px; border-radius: 15px; box-shadow: 0 8px 25px rgba(0,0,0,0.2); }
        .login-header { text-align: center; margin-bottom: 30px; }
        .login-logo { width: 80px; height: 80px; margin: 0 auto 20px; background: linear-gradient(135deg, #00A854, #FECB00); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 2.5em; }
        .login-title { color: #00A854; font-size: 1.8em; margin-bottom: 10px; }
        
        .image-viewer { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 10001; align-items: center; justify-content: center; }
        .image-viewer.active { display: flex; }
        .image-viewer img { max-width: 90%; max-height: 90%; object-fit: contain; }
        .image-viewer .close-viewer { position: absolute; top: 20px; right: 20px; background: white; border: none; width: 50px; height: 50px; border-radius: 50%; cursor: pointer; font-size: 1.5em; }

        .gps-container { display: flex; gap: 20px; height: 700px; }
        .gps-sidebar { width: 350px; background: white; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); display: flex; flex-direction: column; overflow: hidden; }
        .gps-sidebar-header { background: linear-gradient(135deg, #00A854, #FECB00); color: white; padding: 20px; }
        .gps-sidebar-header h2 { font-size: 1.3em; margin-bottom: 5px; }
        .status-bar { padding: 10px 15px; background: #f8f9fa; font-size: 0.85em; }
        .status-bar.connected { background: #d4edda; color: #155724; }
        .status-bar.error { background: #f8d7da; color: #721c24; }
        .gps-filters { padding: 15px; border-bottom: 1px solid #e0e0e0; }
        .filter-group-gps { margin-bottom: 15px; }
        .filter-group-gps label { display: block; font-size: 0.85em; font-weight: 600; color: #666; margin-bottom: 5px; }
        .filter-group-gps select { width: 100%; padding: 8px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 0.9em; }
        .stats-mini { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 15px; border-bottom: 1px solid #e0e0e0; }
        .stat-mini { background: #f8f9fa; padding: 10px; border-radius: 8px; text-align: center; }
        .stat-mini-value { font-size: 1.5em; font-weight: bold; color: #00A854; }
        .stat-mini-label { font-size: 0.75em; color: #666; margin-top: 5px; }
        .sessions-list { flex: 1; overflow-y: auto; padding: 10px; }
        .session-card { background: white; border: 2px solid #e0e0e0; border-radius: 10px; padding: 12px; margin-bottom: 10px; cursor: pointer; transition: all 0.3s; }
        .session-card:hover { border-color: #00A854; box-shadow: 0 4px 12px rgba(0,168,84,0.2); transform: translateY(-2px); }
        .session-card.active { border-color: #00A854; background: #f0fff4; }
        .session-driver { font-weight: bold; font-size: 0.95em; margin-bottom: 8px; color: #00A854; }
        .session-info { font-size: 0.85em; color: #666; }
        .session-info div { margin-bottom: 3px; }
        .map-wrapper { flex: 1; position: relative; background: white; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); overflow: hidden; }
        #map { width: 100%; height: 100%; }
        .debug-toggle { position: absolute; top: 20px; left: 20px; background: #333; color: white; border: none; padding: 10px 15px; border-radius: 8px; cursor: pointer; z-index: 1001; font-size: 14px; }
        .map-controls { position: absolute; top: 20px; right: 20px; background: white; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); padding: 15px; z-index: 1000; min-width: 220px; }
        .map-controls h3 { margin: 0 0 15px 0; font-size: 1em; color: #333; padding-bottom: 10px; border-bottom: 2px solid #f0f0f0; }
        .control-group { margin-bottom: 12px; }
        .control-group label { display: flex; align-items: center; gap: 8px; font-size: 0.9em; cursor: pointer; color: #555; padding: 5px; border-radius: 6px; transition: all 0.2s; }
        .control-group label:hover { background: #f8f9fa; }
        .control-group input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; accent-color: #00A854; }
        .btn-map { width: 100%; padding: 10px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 0.9em; transition: all 0.2s; margin-top: 8px; }
        .btn-map.primary { background: linear-gradient(135deg, #00A854, #00C65E); color: white; }
        .btn-map.secondary { background: #6c757d; color: white; }
        .trajectory-info { position: absolute; bottom: 20px; left: 20px; background: white; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); padding: 15px; z-index: 1000; min-width: 300px; display: none; }
        .trajectory-info.visible { display: block; }
        .trajectory-info h3 { color: #00A854; margin: 0 0 15px 0; font-size: 1em; padding-bottom: 10px; border-bottom: 2px solid #f0f0f0; }
        .trajectory-stats { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .trajectory-stat { background: #f8f9fa; padding: 10px; border-radius: 8px; text-align: center; }
        .trajectory-stat-value { font-size: 1.3em; font-weight: bold; color: #00A854; margin-bottom: 5px; }
        .trajectory-stat-label { font-size: 0.75em; color: #666; }
        .debug-console { position: absolute; bottom: 20px; right: 20px; background: rgba(0,0,0,0.95); color: #0f0; font-family: 'Courier New', monospace; font-size: 0.75em; padding: 15px; border-radius: 10px; max-width: 600px; max-height: 400px; overflow-y: auto; z-index: 2000; display: none; }
        .debug-console.visible { display: block; }
        .empty-state { text-align: center; padding: 40px 20px; color: #999; }
        .empty-state i { font-size: 2.5em; margin-bottom: 10px; opacity: 0.5; }
        .gps-loading-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.95); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 1000; border-radius: 15px; }
        .gps-loading-spinner { width: 60px; height: 60px; border: 6px solid #f0f0f0; border-top-color: #00A854; border-radius: 50%; animation: spin 1s linear infinite; }
        .gps-loading-text { margin-top: 20px; font-size: 1.1em; color: #333; font-weight: 600; }
        .gps-loading-progress { margin-top: 10px; font-size: 0.9em; color: #666; }

        @media (max-width: 768px) {
            .header h1 { font-size: 1.5em; }
            .stats-grid { grid-template-columns: 1fr 1fr; }
            .action-bar { flex-direction: column; align-items: stretch; }
            .search-box { max-width: 100%; }
            .tabs { justify-content: center; }
            .gps-container { flex-direction: column; height: auto; }
            .gps-sidebar { width: 100%; height: 400px; }
            .map-wrapper { height: 500px; }
            .albourakh-account-number { font-size: 1.5em; }
        }
    </style>
</head>
<body>
    <!-- LOGIN SCREEN -->
    <div id="loginScreen">
        <div class="login-container">
            <div class="login-header">
                <div class="login-logo">üîê</div>
                <h1 class="login-title">Administration</h1>
                <p style="color: #666;">Al Bourakh - Gestion Unifi√©e v6.1</p>
            </div>
            <div class="form-group">
                <label>üìß Email Administrateur</label>
                <input type="email" id="adminEmail" placeholder="admin@albourakh.sn">
            </div>
            <div class="form-group">
                <label>üîí Mot de passe</label>
                <input type="password" id="adminPassword" placeholder="Votre mot de passe">
            </div>
            <button class="btn btn-primary" onclick="loginAdmin()" style="width: 100%;">
                <i class="fas fa-sign-in-alt"></i> Se connecter
            </button>
            <p style="text-align: center; margin-top: 20px; color: #999; font-size: 0.9em;">
                Version 6.1 - D√©bit/Cr√©dit Auto ¬© 2025
            </p>
        </div>
    </div>

    <!-- ADMIN DASHBOARD -->
    <div id="adminDashboard" style="display: none;">
        <div class="container">
            <div class="header">
                <h1><i class="fas fa-shield-alt"></i> Administration Unifi√©e v6.1</h1>
                <p>Candidatures ‚Ä¢ Chauffeurs ‚Ä¢ Portefeuille ‚Ä¢ GPS Tracking</p>
                <button class="logout-btn" onclick="logoutAdmin()">
                    <i class="fas fa-sign-out-alt"></i> D√©connexion
                </button>
            </div>

            <div class="tabs">
                <button class="tab-btn active" onclick="switchTab('candidatures')">
                    <i class="fas fa-file-alt"></i> Candidatures
                </button>
                <button class="tab-btn" onclick="switchTab('chauffeurs')">
                    <i class="fas fa-users"></i> Chauffeurs
                </button>
                <button class="tab-btn" onclick="switchTab('portefeuille')">
                    <i class="fas fa-wallet"></i> Portefeuille
                </button>
                <button class="tab-btn" onclick="switchTab('gps')">
                    <i class="fas fa-map-marked-alt"></i> GPS
                </button>
            </div>

            <!-- TAB CANDIDATURES -->
            <div id="tab-candidatures" class="tab-content active">
                <div class="stats-grid">
                    <div class="stat-card"><div class="stat-icon purple"><i class="fas fa-inbox"></i></div><div class="stat-info"><h3 id="totalCandidatures">0</h3><p>Total</p></div></div>
                    <div class="stat-card"><div class="stat-icon orange"><i class="fas fa-clock"></i></div><div class="stat-info"><h3 id="pendingCandidatures">0</h3><p>En Attente</p></div></div>
                    <div class="stat-card"><div class="stat-icon teal"><i class="fas fa-car"></i></div><div class="stat-info"><h3 id="withVehicleCandidatures">0</h3><p>Avec V√©hicule</p></div></div>
                    <div class="stat-card"><div class="stat-icon green"><i class="fas fa-check"></i></div><div class="stat-info"><h3 id="acceptedCandidatures">0</h3><p>Accept√©es</p></div></div>
                </div>
                <div class="main-content">
                    <div class="action-bar">
                        <div class="search-box"><input type="text" id="searchCandidatures" placeholder="Rechercher..." onkeyup="searchCandidatures()"><i class="fas fa-search"></i></div>
                        <div class="filters">
                            <button class="filter-btn active" onclick="filterCandidatures('all', this)">Tous</button>
                            <button class="filter-btn" onclick="filterCandidatures('with-vehicle', this)">Avec v√©hicule</button>
                            <button class="filter-btn" onclick="filterCandidatures('without-vehicle', this)">Sans v√©hicule</button>
                            <button class="btn btn-secondary" onclick="loadCandidatures()"><i class="fas fa-sync-alt"></i></button>
                        </div>
                    </div>
                    <div class="table-container">
                        <table><thead><tr><th>Candidat</th><th>T√©l√©phone</th><th>Type</th><th>Date</th><th>Statut</th><th>Actions</th></tr></thead>
                        <tbody id="candidaturesTableBody"><tr><td colspan="6" style="text-align:center;padding:40px;color:#999;">Chargement...</td></tr></tbody></table>
                    </div>
                </div>
            </div>

            <!-- TAB CHAUFFEURS -->
            <div id="tab-chauffeurs" class="tab-content">
                <div class="stats-grid">
                    <div class="stat-card"><div class="stat-icon green"><i class="fas fa-users"></i></div><div class="stat-info"><h3 id="totalDrivers">0</h3><p>Total</p></div></div>
                    <div class="stat-card"><div class="stat-icon blue"><i class="fas fa-check-circle"></i></div><div class="stat-info"><h3 id="availableDrivers">0</h3><p>Disponibles</p></div></div>
                    <div class="stat-card"><div class="stat-icon orange"><i class="fas fa-car"></i></div><div class="stat-info"><h3 id="busyDrivers">0</h3><p>En Course</p></div></div>
                    <div class="stat-card"><div class="stat-icon red"><i class="fas fa-power-off"></i></div><div class="stat-info"><h3 id="offlineDrivers">0</h3><p>Hors Ligne</p></div></div>
                </div>
                <div class="main-content">
                    <div class="action-bar">
                        <div class="search-box"><input type="text" id="searchDrivers" placeholder="Rechercher..." onkeyup="searchDrivers()"><i class="fas fa-search"></i></div>
                        <div style="display:flex;gap:10px;">
                            <button class="btn btn-primary" onclick="newDriver()"><i class="fas fa-plus"></i> Nouveau</button>
                            <button class="btn btn-secondary" onclick="loadDrivers()"><i class="fas fa-sync-alt"></i></button>
                        </div>
                    </div>
                    <div class="table-container">
                        <table><thead><tr><th>Chauffeur</th><th>T√©l√©phone</th><th>V√©hicule</th><th>Solde</th><th>Statut</th><th>Actions</th></tr></thead>
                        <tbody id="driversTableBody"><tr><td colspan="6" style="text-align:center;padding:40px;color:#999;">Chargement...</td></tr></tbody></table>
                    </div>
                </div>
            </div>

            <!-- TAB PORTEFEUILLE -->
            <div id="tab-portefeuille" class="tab-content">
                <div class="albourakh-main-account">
                    <h2><i class="fas fa-building"></i> Compte Principal Al Bourakh</h2>
                    <div class="albourakh-account-number">+221 78 785 01 01</div>
                    <div class="albourakh-instructions">
                        <h3>üìã Instructions - v6.1 D√©bit/Cr√©dit Automatique</h3>
                        <ul>
                            <li><strong>Recharge Chauffeur :</strong> V√©rifier r√©ception ‚Üí Valider ‚Üí <span style="color:#10b981;">CR√âDIT AUTO du solde</span></li>
                            <li><strong>Retrait Chauffeur :</strong> Effectuer transfert ‚Üí Valider ‚Üí <span style="color:#ef4444;">D√âBIT AUTO du solde</span></li>
                        </ul>
                    </div>
                </div>
                <div class="stats-grid">
                    <div class="stat-card"><div class="stat-icon green"><i class="fas fa-arrow-down"></i></div><div class="stat-info"><h3 id="pendingRecharges">0</h3><p>Recharges Clients</p></div><div class="stat-count"><span id="totalRechargesAmount">0</span> FCFA</div></div>
                    <div class="stat-card"><div class="stat-icon blue"><i class="fas fa-plus-square"></i></div><div class="stat-info"><h3 id="pendingDriverRecharges">0</h3><p>Recharges Chauffeurs</p></div><div class="stat-count"><span id="totalDriverRechargesAmount">0</span> FCFA</div></div>
                    <div class="stat-card"><div class="stat-icon orange"><i class="fas fa-credit-card"></i></div><div class="stat-info"><h3 id="pendingPayments">0</h3><p>Paiements Courses</p></div><div class="stat-count"><span id="totalPaymentsAmount">0</span> FCFA</div></div>
                    <div class="stat-card"><div class="stat-icon red"><i class="fas fa-arrow-up"></i></div><div class="stat-info"><h3 id="pendingWithdrawals">0</h3><p>Retraits</p></div><div class="stat-count"><span id="totalWithdrawalsAmount">0</span> FCFA</div></div>
                </div>
                
                <!-- Recharges Clients -->
                <div class="section">
                    <div class="section-header"><h2 class="section-title"><i class="fas fa-plus-circle"></i> Recharges Clients</h2>
                    <div class="filters"><button class="filter-btn active" onclick="filterRecharges('pending', this)">En attente</button><button class="filter-btn" onclick="filterRecharges('validated', this)">Valid√©es</button><button class="filter-btn" onclick="filterRecharges('all', this)">Toutes</button><button class="btn btn-refresh" onclick="loadPortefeuilleData()"><i class="fas fa-sync"></i></button></div></div>
                    <div class="table-container"><table><thead><tr><th>Client</th><th>T√©l√©phone</th><th>Montant</th><th>Source</th><th>Date</th><th>Statut</th><th>Actions</th></tr></thead><tbody id="rechargesTable"><tr><td colspan="7" style="text-align:center;padding:40px;color:#999;">Chargement...</td></tr></tbody></table></div>
                </div>
                
                <!-- Recharges Chauffeurs -->
                <div class="section">
                    <div class="section-header"><h2 class="section-title"><i class="fas fa-plus-square"></i> Recharges Chauffeurs</h2>
                    <div class="filters"><button class="filter-btn active" onclick="filterDriverRecharges('pending', this)">En attente</button><button class="filter-btn" onclick="filterDriverRecharges('validated', this)">Valid√©es</button><button class="filter-btn" onclick="filterDriverRecharges('all', this)">Toutes</button></div></div>
                    <div class="table-container"><table><thead><tr><th>Chauffeur</th><th>T√©l√©phone</th><th>Montant</th><th>Source</th><th>Date</th><th>Statut</th><th>Actions</th></tr></thead><tbody id="driverRechargesTable"><tr><td colspan="7" style="text-align:center;padding:40px;color:#999;">Chargement...</td></tr></tbody></table></div>
                </div>
                
                <!-- Paiements Courses -->
                <div class="section">
                    <div class="section-header"><h2 class="section-title"><i class="fas fa-car"></i> Paiements Courses</h2>
                    <div class="filters"><button class="filter-btn active" onclick="filterPayments('pending', this)">En attente</button><button class="filter-btn" onclick="filterPayments('validated', this)">Valid√©s</button><button class="filter-btn" onclick="filterPayments('all', this)">Tous</button></div></div>
                    <div class="table-container"><table><thead><tr><th>Client</th><th>Course</th><th>Chauffeur</th><th>Montant</th><th>Date</th><th>Statut</th><th>Actions</th></tr></thead><tbody id="paymentsTable"><tr><td colspan="7" style="text-align:center;padding:40px;color:#999;">Chargement...</td></tr></tbody></table></div>
                </div>
                
                <!-- Retraits Chauffeurs -->
                <div class="section">
                    <div class="section-header"><h2 class="section-title"><i class="fas fa-money-bill-wave"></i> Retraits Chauffeurs</h2>
                    <div class="filters"><button class="filter-btn active" onclick="filterWithdrawals('pending', this)">En attente</button><button class="filter-btn" onclick="filterWithdrawals('completed', this)">Effectu√©s</button><button class="filter-btn" onclick="filterWithdrawals('all', this)">Tous</button></div></div>
                    <div class="table-container"><table><thead><tr><th>Chauffeur</th><th>T√©l√©phone</th><th>Montant</th><th>Destination</th><th>Date</th><th>Statut</th><th>Actions</th></tr></thead><tbody id="withdrawalsTable"><tr><td colspan="7" style="text-align:center;padding:40px;color:#999;">Chargement...</td></tr></tbody></table></div>
                </div>
            </div>

            <!-- TAB GPS -->
            <div id="tab-gps" class="tab-content">
                <div class="gps-container">
                    <div class="gps-sidebar">
                        <div class="gps-sidebar-header"><h2>üõ∞Ô∏è GPS Tracking</h2><p style="font-size:0.9em;opacity:0.9;">Suivi en temps r√©el</p></div>
                        <div class="status-bar" id="statusBar"><i class="fas fa-circle-notch fa-spin"></i> Initialisation...</div>
                        <div class="gps-filters">
                            <div class="filter-group-gps"><label>Chauffeur</label><select id="filterDriver"><option value="">Tous</option></select></div>
                            <div class="filter-group-gps"><label>Statut</label><select id="filterStatus"><option value="">Tous</option><option value="active">Actives</option><option value="completed">Termin√©es</option></select></div>
                            <button class="btn btn-primary" id="btnRefresh" style="width:100%;"><i class="fas fa-sync-alt"></i> Actualiser</button>
                        </div>
                        <div class="stats-mini">
                            <div class="stat-mini"><div class="stat-mini-value" id="totalSessions">0</div><div class="stat-mini-label">Sessions</div></div>
                            <div class="stat-mini"><div class="stat-mini-value" id="activeSessions">0</div><div class="stat-mini-label">Actives</div></div>
                            <div class="stat-mini"><div class="stat-mini-value" id="totalDistance">0</div><div class="stat-mini-label">km Total</div></div>
                            <div class="stat-mini"><div class="stat-mini-value" id="totalPositions">0</div><div class="stat-mini-label">Positions</div></div>
                        </div>
                        <div class="sessions-list" id="sessionsList"><div class="empty-state"><i class="fas fa-route"></i><p>Chargement...</p></div></div>
                    </div>
                    <div class="map-wrapper">
                        <div class="gps-loading-overlay" id="gpsLoadingOverlay" style="display:none;"><div class="gps-loading-spinner"></div><div class="gps-loading-text">Chargement GPS...</div><div class="gps-loading-progress" id="gpsLoadingProgress">Initialisation...</div></div>
                        <button class="debug-toggle" id="debugBtn"><i class="fas fa-terminal"></i> Debug</button>
                        <div id="map"></div>
                        <div class="map-controls">
                            <h3>üéõÔ∏è Options</h3>
                            <div class="control-group"><label><input type="checkbox" id="showMarkers" checked onchange="toggleMarkers()"><span>üìç Marqueurs</span></label></div>
                            <div class="control-group"><label><input type="checkbox" id="showTrajectory" checked onchange="toggleTrajectory()"><span>üìà Trajet</span></label></div>
                            <button class="btn-map primary" onclick="centerOnTrajectory()"><i class="fas fa-crosshairs"></i> Centrer</button>
                            <button class="btn-map secondary" onclick="clearMapDisplay()"><i class="fas fa-eraser"></i> Effacer</button>
                        </div>
                        <div class="trajectory-info" id="trajectoryInfo">
                            <h3>üìä Informations du trajet</h3>
                            <div class="trajectory-stats">
                                <div class="trajectory-stat"><div class="trajectory-stat-value" id="trajDistance">0 km</div><div class="trajectory-stat-label">Distance</div></div>
                                <div class="trajectory-stat"><div class="trajectory-stat-value" id="trajDuration">0 min</div><div class="trajectory-stat-label">Dur√©e</div></div>
                                <div class="trajectory-stat"><div class="trajectory-stat-value" id="trajSpeed">0 km/h</div><div class="trajectory-stat-label">Vitesse moy.</div></div>
                                <div class="trajectory-stat"><div class="trajectory-stat-value" id="trajPoints">0</div><div class="trajectory-stat-label">Points GPS</div></div>
                            </div>
                        </div>
                        <div class="debug-console" id="debugConsole"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODALS -->
    <div class="modal" id="detailsModal"><div class="modal-content"><div class="modal-header"><h2 id="modalTitle">D√©tails</h2><button class="modal-close" onclick="closeModal('detailsModal')">√ó</button></div><div class="modal-body" id="modalBody"></div></div></div>
    <div class="modal" id="rechargeModal"><div class="modal-content"><div class="modal-header"><h2><i class="fas fa-plus-circle"></i> Validation Recharge Client</h2><button class="modal-close" onclick="closeModal('rechargeModal')">√ó</button></div><div class="modal-body" id="rechargeModalBody"></div></div></div>
    <div class="modal" id="driverRechargeModal"><div class="modal-content"><div class="modal-header" style="background: linear-gradient(135deg, #10b981, #059669);"><h2><i class="fas fa-plus-square"></i> Validation Recharge Chauffeur</h2><button class="modal-close" onclick="closeModal('driverRechargeModal')">√ó</button></div><div class="modal-body" id="driverRechargeModalBody"></div></div></div>
    <div class="modal" id="paymentModal"><div class="modal-content"><div class="modal-header"><h2><i class="fas fa-credit-card"></i> Validation Paiement Course</h2><button class="modal-close" onclick="closeModal('paymentModal')">√ó</button></div><div class="modal-body" id="paymentModalBody"></div></div></div>
    <div class="modal" id="withdrawalModal"><div class="modal-content"><div class="modal-header" style="background: linear-gradient(135deg, #ef4444, #dc2626);"><h2><i class="fas fa-money-bill-wave"></i> Validation Retrait</h2><button class="modal-close" onclick="closeModal('withdrawalModal')">√ó</button></div><div class="modal-body" id="withdrawalModalBody"></div></div></div>
    <div class="image-viewer" id="imageViewer" onclick="closeImageViewer()"><button class="close-viewer" onclick="closeImageViewer()">√ó</button><img id="viewerImage" src="" alt="Document"></div>
    <div class="loading" id="loading"><div class="spinner"></div><div class="loading-text">Chargement...</div></div>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyANcdvMz2yMbRD4V82EGLm95Jh2NdaR2o0",
            authDomain: "albourakh-sn-ok.firebaseapp.com",
            projectId: "albourakh-sn-ok",
            storageBucket: "albourakh-sn-ok.firebasestorage.app",
            messagingSenderId: "297875396274",
            appId: "1:297875396274:web:82a466c4fce6fbb79b1bab"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        const ALBOURAKH_ACCOUNT = '+221 78 785 01 01';
        const COMMISSION_RATE = 0.30;
        const DRIVER_RATE = 0.70;

        let allCandidatures = [], allDrivers = [], allRecharges = [], allDriverRecharges = [], allPayments = [], allWithdrawals = [], allSessions = [], allDriversGPS = {};
        let currentCandFilter = 'all', currentRechargeFilter = 'pending', currentDriverRechargeFilter = 'pending', currentPaymentFilter = 'pending', currentWithdrawalFilter = 'pending';
        let map, markers = [], polylines = [], currentPositions = [], isAuth = false, currentSessionId = null, mapInitialized = false;

        function showToast(msg, type = 'info') { const t = document.createElement('div'); t.className = `toast ${type}`; t.innerHTML = `<strong>${msg}</strong>`; document.body.appendChild(t); setTimeout(() => { t.style.opacity = '0'; setTimeout(() => t.remove(), 300); }, 3000); }
        function showLoading(txt = 'Chargement...') { document.querySelector('.loading-text').textContent = txt; document.getElementById('loading').classList.add('active'); }
        function hideLoading() { document.getElementById('loading').classList.remove('active'); }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }
        function formatDate(ts) { if (!ts) return 'N/A'; const d = ts.toDate ? ts.toDate() : new Date(ts); return d.toLocaleString('fr-FR'); }
        function getStatusLabel(s) { const l = { 'en_attente': '‚è≥ En Attente', 'acceptee': '‚úÖ Accept√©e', 'refusee': '‚ùå Refus√©e', 'disponible': 'üü¢ Disponible', 'en_course': 'üîµ En Course', 'hors_ligne': '‚ö´ Hors Ligne', 'pending': '‚è≥ En attente', 'validated': '‚úÖ Valid√©', 'completed': '‚úÖ Effectu√©', 'active': 'üîµ Active' }; return l[s] || s; }

        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            event.target.closest('.tab-btn').classList.add('active');
            document.getElementById(`tab-${tab}`).classList.add('active');
            if (tab === 'candidatures') loadCandidatures();
            else if (tab === 'chauffeurs') loadDrivers();
            else if (tab === 'portefeuille') loadPortefeuilleData();
            else if (tab === 'gps') { if (!mapInitialized) { showGPSLoader(); initGoogleMaps(); } else { loadSessions(); } }
        }

        async function loginAdmin() {
            const email = document.getElementById('adminEmail').value.trim();
            const pwd = document.getElementById('adminPassword').value.trim();
            if (!email || !pwd) { showToast('Remplissez tous les champs', 'error'); return; }
            showLoading('Connexion...');
            try {
                await auth.signInWithEmailAndPassword(email, pwd);
                isAuth = true; hideLoading(); showToast('‚úÖ Connexion r√©ussie!', 'success');
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('adminDashboard').style.display = 'block';
                loadCandidatures();
            } catch (e) { hideLoading(); showToast('Email ou mot de passe incorrect', 'error'); }
        }
        async function logoutAdmin() { if (confirm('D√©connexion ?')) { await auth.signOut(); isAuth = false; document.getElementById('loginScreen').style.display = 'block'; document.getElementById('adminDashboard').style.display = 'none'; } }
        document.getElementById('adminPassword').addEventListener('keypress', e => { if (e.key === 'Enter') loginAdmin(); });

        // ========== CANDIDATURES ==========
        async function loadCandidatures() {
            if (!auth.currentUser) return;
            showLoading('Chargement candidatures...');
            try {
                const snap = await db.collection('candidatures').get();
                allCandidatures = []; snap.forEach(doc => allCandidatures.push({ id: doc.id, ...doc.data() }));
                allCandidatures.sort((a, b) => { const dA = a.dateCreation?.toDate?.() || new Date(0); const dB = b.dateCreation?.toDate?.() || new Date(0); return dB - dA; });
                updateCandidaturesStats(); displayCandidatures(allCandidatures); hideLoading();
            } catch (e) { hideLoading(); showToast('Erreur: ' + e.message, 'error'); }
        }
        function updateCandidaturesStats() {
            document.getElementById('totalCandidatures').textContent = allCandidatures.length;
            document.getElementById('pendingCandidatures').textContent = allCandidatures.filter(c => !c.statut || c.statut === 'en_attente' || c.statut === 'nouvelle').length;
            document.getElementById('withVehicleCandidatures').textContent = allCandidatures.filter(c => c.hasVehicle === true).length;
            document.getElementById('acceptedCandidatures').textContent = allCandidatures.filter(c => c.statut === 'acceptee' || c.statut === 'validee').length;
        }
        function filterCandidatures(filter, btn) { currentCandFilter = filter; btn.parentElement.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active')); btn.classList.add('active'); let filtered = allCandidatures; if (filter === 'with-vehicle') filtered = allCandidatures.filter(c => c.hasVehicle === true); else if (filter === 'without-vehicle') filtered = allCandidatures.filter(c => c.hasVehicle === false); displayCandidatures(filtered); }
        function displayCandidatures(list) { const tbody = document.getElementById('candidaturesTableBody'); if (!list.length) { tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:40px;color:#999;">Aucune candidature</td></tr>'; return; } tbody.innerHTML = list.map(c => { let statut = c.statut || 'en_attente'; const isPending = statut === 'en_attente' || statut === 'nouvelle' || !c.statut; const hasVehicle = c.hasVehicle === true; const date = c.dateCreation?.toDate ? c.dateCreation.toDate().toLocaleDateString('fr-FR') : 'N/A'; return `<tr><td><strong>${c.prenom || ''} ${c.nom || ''}</strong><br><small style="color:#666;">${c.email || ''}</small></td><td>${c.telephone || 'N/A'}</td><td><span class="type-badge ${hasVehicle ? 'type-with-vehicle' : 'type-without-vehicle'}">${hasVehicle ? 'üöó V√©hicule' : 'üë§ Sans'}</span></td><td>${date}</td><td><span class="status-badge status-${statut}">${getStatusLabel(statut)}</span></td><td><div class="action-buttons"><button class="btn btn-icon btn-view" onclick="viewCandidature('${c.id}')"><i class="fas fa-eye"></i></button>${isPending ? `<button class="btn btn-icon btn-accept" onclick="acceptCandidature('${c.id}')"><i class="fas fa-check"></i></button><button class="btn btn-icon btn-reject" onclick="rejectCandidature('${c.id}')"><i class="fas fa-times"></i></button>` : ''}<button class="btn btn-icon btn-delete" onclick="deleteCandidature('${c.id}')"><i class="fas fa-trash"></i></button></div></td></tr>`; }).join(''); }
        function searchCandidatures() { const term = document.getElementById('searchCandidatures').value.toLowerCase(); let filtered = allCandidatures.filter(c => (c.prenom?.toLowerCase().includes(term)) || (c.nom?.toLowerCase().includes(term)) || (c.telephone?.includes(term))); displayCandidatures(filtered); }
        function viewCandidature(id) { const c = allCandidatures.find(x => x.id === id); if (!c) return; const hasVehicle = c.hasVehicle === true; document.getElementById('modalTitle').textContent = `üë§ ${c.prenom || ''} ${c.nom || ''}`; document.getElementById('modalBody').innerHTML = `<div class="info-section"><h4><i class="fas fa-user"></i> Informations</h4><div class="info-grid"><div class="info-item"><label>Nom</label><span>${c.prenom || ''} ${c.nom || ''}</span></div><div class="info-item"><label>T√©l√©phone</label><span>${c.telephone || 'N/A'}</span></div><div class="info-item"><label>Email</label><span>${c.email || 'N/A'}</span></div><div class="info-item"><label>Type</label><span class="type-badge ${hasVehicle ? 'type-with-vehicle' : 'type-without-vehicle'}">${hasVehicle ? 'üöó Avec v√©hicule' : 'üë§ Sans v√©hicule'}</span></div></div></div>`; document.getElementById('detailsModal').classList.add('active'); }
        async function acceptCandidature(id) { const c = allCandidatures.find(x => x.id === id); if (!confirm(`Accepter ${c.prenom} ${c.nom} ?`)) return; showLoading('Cr√©ation compte...'); try { const driverData = { prenom: c.prenom || '', nom: c.nom || '', nomComplet: `${c.prenom || ''} ${c.nom || ''}`.trim(), email: c.email || '', telephone: c.telephone || '', hasVehicle: c.hasVehicle, vehicule: c.vehicule || {}, statut: 'hors_ligne', actif: true, rating: 5.0, coursesCompletees: 0, soldeDisponible: 0, dateCreation: firebase.firestore.FieldValue.serverTimestamp() }; const ref = await db.collection('drivers').add(driverData); await db.collection('candidatures').doc(id).update({ statut: 'acceptee', driverId: ref.id, dateTraitement: firebase.firestore.FieldValue.serverTimestamp() }); hideLoading(); closeModal('detailsModal'); showToast('‚úÖ Chauffeur cr√©√©!', 'success'); loadCandidatures(); } catch (e) { hideLoading(); showToast('Erreur: ' + e.message, 'error'); } }
        async function rejectCandidature(id) { const c = allCandidatures.find(x => x.id === id); if (!confirm(`Refuser ${c.prenom} ${c.nom} ?`)) return; showLoading(); try { await db.collection('candidatures').doc(id).update({ statut: 'refusee', dateTraitement: firebase.firestore.FieldValue.serverTimestamp() }); hideLoading(); showToast('Candidature refus√©e', 'info'); loadCandidatures(); } catch (e) { hideLoading(); showToast('Erreur: ' + e.message, 'error'); } }
        async function deleteCandidature(id) { if (!confirm('Supprimer ?')) return; showLoading(); try { await db.collection('candidatures').doc(id).delete(); hideLoading(); showToast('Supprim√©', 'success'); loadCandidatures(); } catch (e) { hideLoading(); showToast('Erreur: ' + e.message, 'error'); } }

        // ========== CHAUFFEURS ==========
        async function loadDrivers() {
            if (!auth.currentUser) return;
            showLoading('Chargement chauffeurs...');
            try {
                const snap = await db.collection('drivers').get();
                allDrivers = []; snap.forEach(doc => allDrivers.push({ id: doc.id, ...doc.data() }));
                updateDriversStats(); displayDrivers(allDrivers); hideLoading();
            } catch (e) { hideLoading(); showToast('Erreur: ' + e.message, 'error'); }
        }
        function updateDriversStats() {
            document.getElementById('totalDrivers').textContent = allDrivers.length;
            document.getElementById('availableDrivers').textContent = allDrivers.filter(d => d.statut === 'disponible').length;
            document.getElementById('busyDrivers').textContent = allDrivers.filter(d => d.statut === 'en_course').length;
            document.getElementById('offlineDrivers').textContent = allDrivers.filter(d => d.statut === 'hors_ligne' || !d.statut).length;
        }
        function displayDrivers(list) { const tbody = document.getElementById('driversTableBody'); if (!list.length) { tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:40px;color:#999;">Aucun chauffeur</td></tr>'; return; } tbody.innerHTML = list.map(d => `<tr><td><strong>${d.prenom || ''} ${d.nom || ''}</strong></td><td>${d.telephone || 'N/A'}</td><td>${d.vehicule?.marque || ''} ${d.vehicule?.modele || ''}</td><td><span style="color:#00A854;font-weight:bold;">${(d.soldeDisponible || 0).toLocaleString()} F</span></td><td><span class="status-badge status-${d.statut || 'hors_ligne'}">${getStatusLabel(d.statut || 'hors_ligne')}</span></td><td><div class="action-buttons"><button class="btn btn-icon btn-view" onclick="viewDriver('${d.id}')"><i class="fas fa-eye"></i></button><button class="btn btn-icon btn-edit" onclick="editDriver('${d.id}')"><i class="fas fa-edit"></i></button><button class="btn btn-icon btn-delete" onclick="deleteDriver('${d.id}')"><i class="fas fa-trash"></i></button></div></td></tr>`).join(''); }
        function searchDrivers() { const term = document.getElementById('searchDrivers').value.toLowerCase(); displayDrivers(allDrivers.filter(d => (d.prenom?.toLowerCase().includes(term)) || (d.nom?.toLowerCase().includes(term)) || (d.telephone?.includes(term)))); }
        function viewDriver(id) { const d = allDrivers.find(x => x.id === id); if (!d) return; document.getElementById('modalTitle').textContent = `üë§ ${d.prenom || ''} ${d.nom || ''}`; document.getElementById('modalBody').innerHTML = `<div class="info-section"><h4><i class="fas fa-user"></i> Informations</h4><div class="info-grid"><div class="info-item"><label>Nom</label><span>${d.prenom || ''} ${d.nom || ''}</span></div><div class="info-item"><label>T√©l√©phone</label><span>${d.telephone || 'N/A'}</span></div><div class="info-item"><label>Solde</label><span style="color:#00A854;font-weight:bold;font-size:1.3em;">${(d.soldeDisponible || 0).toLocaleString()} FCFA</span></div><div class="info-item"><label>Courses</label><span>${d.coursesCompletees || 0}</span></div><div class="info-item"><label>ID</label><span style="font-size:0.7em;">${d.id}</span></div></div></div>`; document.getElementById('detailsModal').classList.add('active'); }
        function editDriver(id) { const d = allDrivers.find(x => x.id === id); if (!d) return; document.getElementById('modalTitle').textContent = `‚úèÔ∏è Modifier`; document.getElementById('modalBody').innerHTML = `<div class="form-group"><label>Pr√©nom</label><input type="text" id="editPrenom" value="${d.prenom || ''}"></div><div class="form-group"><label>Nom</label><input type="text" id="editNom" value="${d.nom || ''}"></div><div class="form-group"><label>T√©l√©phone</label><input type="text" id="editTel" value="${d.telephone || ''}"></div><div class="form-group"><label>Solde Disponible (FCFA)</label><input type="number" id="editSolde" value="${d.soldeDisponible || 0}"></div><div class="form-group"><label>Statut</label><select id="editStatut"><option value="disponible" ${d.statut === 'disponible' ? 'selected' : ''}>Disponible</option><option value="en_course" ${d.statut === 'en_course' ? 'selected' : ''}>En Course</option><option value="hors_ligne" ${d.statut === 'hors_ligne' ? 'selected' : ''}>Hors Ligne</option></select></div><button class="btn btn-primary" onclick="saveDriver('${id}')" style="width:100%;"><i class="fas fa-save"></i> Enregistrer</button>`; document.getElementById('detailsModal').classList.add('active'); }
        async function saveDriver(id) { showLoading(); try { await db.collection('drivers').doc(id).update({ prenom: document.getElementById('editPrenom').value, nom: document.getElementById('editNom').value, telephone: document.getElementById('editTel').value, soldeDisponible: parseInt(document.getElementById('editSolde').value) || 0, statut: document.getElementById('editStatut').value }); hideLoading(); closeModal('detailsModal'); showToast('‚úÖ Modifi√©', 'success'); loadDrivers(); } catch (e) { hideLoading(); showToast('Erreur: ' + e.message, 'error'); } }
        async function deleteDriver(id) { if (!confirm('Supprimer ?')) return; showLoading(); try { await db.collection('drivers').doc(id).delete(); hideLoading(); showToast('Supprim√©', 'success'); loadDrivers(); } catch (e) { hideLoading(); showToast('Erreur: ' + e.message, 'error'); } }
        function newDriver() { document.getElementById('modalTitle').textContent = '‚ûï Nouveau Chauffeur'; document.getElementById('modalBody').innerHTML = `<div class="form-group"><label>Pr√©nom *</label><input type="text" id="newPrenom"></div><div class="form-group"><label>Nom *</label><input type="text" id="newNom"></div><div class="form-group"><label>T√©l√©phone *</label><input type="text" id="newTel"></div><div class="form-group"><label>Email</label><input type="email" id="newEmail"></div><button class="btn btn-primary" onclick="createDriver()" style="width:100%;"><i class="fas fa-plus"></i> Cr√©er</button>`; document.getElementById('detailsModal').classList.add('active'); }
        async function createDriver() { const p = document.getElementById('newPrenom').value.trim(), n = document.getElementById('newNom').value.trim(), t = document.getElementById('newTel').value.trim(); if (!p || !n || !t) { showToast('Champs requis', 'error'); return; } showLoading(); try { await db.collection('drivers').add({ prenom: p, nom: n, telephone: t, email: document.getElementById('newEmail').value.trim(), statut: 'hors_ligne', actif: true, rating: 5.0, coursesCompletees: 0, soldeDisponible: 0, dateCreation: firebase.firestore.FieldValue.serverTimestamp() }); hideLoading(); closeModal('detailsModal'); showToast('‚úÖ Cr√©√©', 'success'); loadDrivers(); } catch (e) { hideLoading(); showToast('Erreur: ' + e.message, 'error'); } }

        // ========== PORTEFEUILLE ==========
        async function loadPortefeuilleData() {
            showLoading('Chargement portefeuille...');
            try {
                const [rSnap, drSnap, pSnap, wSnap] = await Promise.all([
                    db.collection('recharges').get(),
                    db.collection('driver_recharges').get(),
                    db.collection('course_payments').get(),
                    db.collection('withdrawals').get()
                ]);
                allRecharges = []; rSnap.forEach(d => allRecharges.push({ id: d.id, ...d.data() }));
                allDriverRecharges = []; drSnap.forEach(d => allDriverRecharges.push({ id: d.id, ...d.data() }));
                allPayments = []; pSnap.forEach(d => allPayments.push({ id: d.id, ...d.data() }));
                allWithdrawals = []; wSnap.forEach(d => allWithdrawals.push({ id: d.id, ...d.data() }));
                
                // Sort by date
                const sortByDate = (a, b) => { const dA = a.createdAt?.toDate?.() || new Date(0); const dB = b.createdAt?.toDate?.() || new Date(0); return dB - dA; };
                allRecharges.sort(sortByDate); allDriverRecharges.sort(sortByDate); allPayments.sort(sortByDate); allWithdrawals.sort(sortByDate);
                
                updatePortefeuilleStats();
                filterRecharges(currentRechargeFilter); filterDriverRecharges(currentDriverRechargeFilter); filterPayments(currentPaymentFilter); filterWithdrawals(currentWithdrawalFilter);
                hideLoading();
            } catch (e) { hideLoading(); showToast('Erreur: ' + e.message, 'error'); }
        }
        function updatePortefeuilleStats() {
            const pR = allRecharges.filter(r => r.status === 'pending'), pDR = allDriverRecharges.filter(r => r.status === 'pending'), pP = allPayments.filter(p => p.status === 'pending'), pW = allWithdrawals.filter(w => w.status === 'pending');
            document.getElementById('pendingRecharges').textContent = pR.length;
            document.getElementById('totalRechargesAmount').textContent = pR.reduce((s, r) => s + (r.amount || 0), 0).toLocaleString();
            document.getElementById('pendingDriverRecharges').textContent = pDR.length;
            document.getElementById('totalDriverRechargesAmount').textContent = pDR.reduce((s, r) => s + (r.amount || 0), 0).toLocaleString();
            document.getElementById('pendingPayments').textContent = pP.length;
            document.getElementById('totalPaymentsAmount').textContent = pP.reduce((s, p) => s + (p.amount || 0), 0).toLocaleString();
            document.getElementById('pendingWithdrawals').textContent = pW.length;
            document.getElementById('totalWithdrawalsAmount').textContent = pW.reduce((s, w) => s + (w.amount || 0), 0).toLocaleString();
        }
        
        function filterRecharges(filter, btn) { currentRechargeFilter = filter; if (btn) { btn.parentElement.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active')); btn.classList.add('active'); } displayRecharges(filter === 'all' ? allRecharges : allRecharges.filter(r => r.status === filter)); }
        function filterDriverRecharges(filter, btn) { currentDriverRechargeFilter = filter; if (btn) { btn.parentElement.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active')); btn.classList.add('active'); } displayDriverRecharges(filter === 'all' ? allDriverRecharges : allDriverRecharges.filter(r => r.status === filter)); }
        function filterPayments(filter, btn) { currentPaymentFilter = filter; if (btn) { btn.parentElement.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active')); btn.classList.add('active'); } displayPayments(filter === 'all' ? allPayments : allPayments.filter(p => p.status === filter)); }
        function filterWithdrawals(filter, btn) { currentWithdrawalFilter = filter; if (btn) { btn.parentElement.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active')); btn.classList.add('active'); } displayWithdrawals(filter === 'all' ? allWithdrawals : allWithdrawals.filter(w => w.status === filter)); }
        
        function displayRecharges(list) { const tbody = document.getElementById('rechargesTable'); if (!list.length) { tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;padding:40px;color:#999;">Aucune recharge</td></tr>'; return; } tbody.innerHTML = list.map(r => `<tr><td><strong>${r.clientNom || 'Client'}</strong></td><td>${r.clientTelephone || 'N/A'}</td><td><span class="amount-highlight amount-credit">+${(r.amount || 0).toLocaleString()} FCFA</span></td><td>${r.source || 'Mobile Money'}</td><td>${formatDate(r.createdAt)}</td><td><span class="status-badge status-${r.status}">${r.status === 'validated' ? '‚úÖ Valid√©e' : '‚è≥ En attente'}</span></td><td><button class="btn btn-icon btn-view" onclick="viewRecharge('${r.id}')"><i class="fas fa-eye"></i></button>${r.status === 'pending' ? `<button class="btn btn-icon btn-validate" onclick="validateRecharge('${r.id}')"><i class="fas fa-check"></i></button>` : ''}</td></tr>`).join(''); }
        
        function displayDriverRecharges(list) { const tbody = document.getElementById('driverRechargesTable'); if (!list.length) { tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;padding:40px;color:#999;">Aucune recharge</td></tr>'; return; } tbody.innerHTML = list.map(r => `<tr><td><strong>${r.driverNom || 'Chauffeur'}</strong></td><td>${r.driverTelephone || 'N/A'}</td><td><span class="amount-highlight amount-credit">+${(r.amount || 0).toLocaleString()} FCFA</span></td><td>${r.source || 'Mobile Money'}</td><td>${formatDate(r.createdAt)}</td><td><span class="status-badge status-${r.status}">${r.status === 'validated' ? '‚úÖ Valid√©e' : '‚è≥ En attente'}</span></td><td><button class="btn btn-icon btn-view" onclick="viewDriverRecharge('${r.id}')"><i class="fas fa-eye"></i></button>${r.status === 'pending' ? `<button class="btn btn-icon btn-validate" onclick="viewDriverRecharge('${r.id}')"><i class="fas fa-check"></i></button>` : ''}</td></tr>`).join(''); }
        
        function displayPayments(list) { const tbody = document.getElementById('paymentsTable'); if (!list.length) { tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;padding:40px;color:#999;">Aucun paiement</td></tr>'; return; } tbody.innerHTML = list.map(p => `<tr><td><strong>${p.clientNom || 'Client'}</strong></td><td>${(p.depart || '').substring(0, 15)}... ‚Üí ${(p.destination || '').substring(0, 15)}...</td><td>${p.chauffeurNom || 'Chauffeur'}</td><td><span class="amount-highlight amount-credit">+${(p.amount || 0).toLocaleString()} FCFA</span></td><td>${formatDate(p.createdAt)}</td><td><span class="status-badge status-${p.status}">${p.status === 'validated' ? '‚úÖ Valid√©' : '‚è≥ En attente'}</span></td><td><button class="btn btn-icon btn-view" onclick="viewPayment('${p.id}')"><i class="fas fa-eye"></i></button>${p.status === 'pending' ? `<button class="btn btn-icon btn-validate" onclick="validatePayment('${p.id}')"><i class="fas fa-check"></i></button>` : ''}</td></tr>`).join(''); }
        
        function displayWithdrawals(list) { const tbody = document.getElementById('withdrawalsTable'); if (!list.length) { tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;padding:40px;color:#999;">Aucun retrait</td></tr>'; return; } tbody.innerHTML = list.map(w => `<tr><td><strong>${w.driverNom || 'Chauffeur'}</strong></td><td>${w.driverTelephone || 'N/A'}</td><td><span class="amount-highlight amount-debit">-${(w.amount || 0).toLocaleString()} FCFA</span></td><td>${w.destination || 'Mobile Money'}</td><td>${formatDate(w.createdAt)}</td><td><span class="status-badge status-${w.status === 'completed' ? 'completed' : 'pending'}">${w.status === 'completed' ? '‚úÖ Effectu√©' : '‚è≥ En attente'}</span></td><td><button class="btn btn-icon btn-view" onclick="viewWithdrawal('${w.id}')"><i class="fas fa-eye"></i></button>${w.status === 'pending' ? `<button class="btn btn-icon btn-validate" onclick="viewWithdrawal('${w.id}')"><i class="fas fa-check"></i></button>` : ''}</td></tr>`).join(''); }
        
        // ========== RECHARGES CLIENT ==========
        function viewRecharge(id) { const r = allRecharges.find(x => x.id === id); if (!r) return; document.getElementById('rechargeModalBody').innerHTML = `<div class="validation-instructions"><h4><i class="fas fa-exclamation-triangle"></i> Proc√©dure</h4><ol><li>V√©rifiez r√©ception de <strong>${(r.amount || 0).toLocaleString()} FCFA</strong> sur <strong>${ALBOURAKH_ACCOUNT}</strong></li><li>Source: <strong>${r.clientTelephone}</strong> via <strong>${r.source}</strong></li></ol></div><div class="info-section"><h4><i class="fas fa-user"></i> Client</h4><div class="info-grid"><div class="info-item"><label>Nom</label><span>${r.clientNom || 'N/A'}</span></div><div class="info-item"><label>Montant</label><span class="amount-highlight amount-credit">${(r.amount || 0).toLocaleString()} FCFA</span></div></div></div>${r.status === 'pending' ? `<button class="btn btn-success" onclick="confirmValidateRecharge('${r.id}')" style="width:100%;margin-top:20px;"><i class="fas fa-check-circle"></i> Valider</button>` : ''}`; document.getElementById('rechargeModal').classList.add('active'); }
        async function confirmValidateRecharge(id) { const r = allRecharges.find(x => x.id === id); if (!confirm(`Confirmer r√©ception de ${r.amount.toLocaleString()} FCFA ?`)) return; showLoading(); try { await db.collection('recharges').doc(id).update({ status: 'validated', validatedAt: firebase.firestore.FieldValue.serverTimestamp() }); if (r.clientId) await db.collection('clients').doc(r.clientId).update({ soldePortefeuille: firebase.firestore.FieldValue.increment(r.amount) }); closeModal('rechargeModal'); hideLoading(); showToast('‚úÖ Recharge valid√©e!', 'success'); loadPortefeuilleData(); } catch (e) { hideLoading(); showToast('Erreur: ' + e.message, 'error'); } }
        function validateRecharge(id) { viewRecharge(id); }
        
        // ========== RECHARGES CHAUFFEUR - CR√âDIT AUTO ==========
        function viewDriverRecharge(id) { 
            const r = allDriverRecharges.find(x => x.id === id); 
            if (!r) return; 
            
            document.getElementById('driverRechargeModalBody').innerHTML = `
                <div class="validation-instructions" style="background: linear-gradient(135deg, #d1fae5, #a7f3d0); border-color: #10b981;">
                    <h4 style="color: #065f46;"><i class="fas fa-info-circle"></i> Proc√©dure - CR√âDIT AUTOMATIQUE</h4>
                    <ol style="color: #047857;">
                        <li>V√©rifiez la r√©ception de <strong>${(r.amount || 0).toLocaleString()} FCFA</strong> sur le compte <strong>${ALBOURAKH_ACCOUNT}</strong></li>
                        <li>Source du paiement: <strong>${r.driverTelephone || 'N/A'}</strong> via <strong>${r.source || 'Mobile Money'}</strong></li>
                        <li>Cliquez sur Valider pour <strong style="color:#059669;">CR√âDITER automatiquement</strong> le solde du chauffeur</li>
                    </ol>
                </div>
                
                <div class="info-section">
                    <h4><i class="fas fa-user-tie"></i> Chauffeur</h4>
                    <div class="info-grid">
                        <div class="info-item"><label>Nom</label><span>${r.driverNom || 'N/A'}</span></div>
                        <div class="info-item"><label>T√©l√©phone</label><span>${r.driverTelephone || 'N/A'}</span></div>
                        <div class="info-item"><label>Source</label><span>${r.source || 'Mobile Money'}</span></div>
                        <div class="info-item"><label>Driver ID</label><span style="font-size:0.65em;word-break:break-all;">${r.driverId || '‚ö†Ô∏è MANQUANT'}</span></div>
                    </div>
                </div>
                
                <div class="info-section" style="background:#d1fae5;">
                    <h4 style="color:#059669;"><i class="fas fa-plus-circle"></i> Montant √† Cr√©diter</h4>
                    <div style="text-align:center;padding:15px;">
                        <span style="font-size:2.5em;font-weight:bold;color:#059669;">+${(r.amount||0).toLocaleString()} FCFA</span>
                    </div>
                </div>
                
                ${!r.driverId ? `<div class="alert-box danger"><i class="fas fa-exclamation-triangle"></i><div><strong>‚ö†Ô∏è ATTENTION</strong><p>driverId manquant - Impossible de cr√©diter automatiquement</p></div></div>` : ''}
                
                ${r.status === 'pending' ? `<button class="btn btn-success" onclick="confirmValidateDriverRecharge('${r.id}')" style="width:100%;margin-top:20px;" ${!r.driverId ? 'disabled' : ''}><i class="fas fa-check-circle"></i> Valider et Cr√©diter le Solde</button>` : `<div class="alert-box info" style="margin-top:20px;"><i class="fas fa-check-circle"></i><div><strong>D√©j√† valid√©e</strong><p>Valid√©e le ${r.validatedAt ? formatDate(r.validatedAt) : 'N/A'}</p></div></div>`}
            `; 
            document.getElementById('driverRechargeModal').classList.add('active'); 
        }
        
        async function confirmValidateDriverRecharge(id) { 
            const r = allDriverRecharges.find(x => x.id === id); 
            if (!r) { showToast('Recharge non trouv√©e', 'error'); return; }
            if (!r.driverId) { showToast('‚ö†Ô∏è Impossible de cr√©diter: driverId manquant', 'error'); return; }
            if (!confirm(`Confirmer r√©ception de ${r.amount.toLocaleString()} FCFA ?\n\n‚úÖ Le solde du chauffeur sera CR√âDIT√â automatiquement.`)) return; 
            
            showLoading('Validation et cr√©dit du solde...'); 
            try { 
                const batch = db.batch();
                batch.update(db.collection('driver_recharges').doc(id), { status: 'validated', validatedAt: firebase.firestore.FieldValue.serverTimestamp(), validatedBy: 'admin' });
                batch.update(db.collection('drivers').doc(r.driverId), { soldeDisponible: firebase.firestore.FieldValue.increment(r.amount) });
                await batch.commit();
                console.log(`‚úÖ Recharge valid√©e: +${r.amount} FCFA pour ${r.driverId}`);
                closeModal('driverRechargeModal'); hideLoading(); 
                showToast(`‚úÖ Recharge de ${r.amount.toLocaleString()} FCFA valid√©e et cr√©dit√©e!`, 'success'); 
                loadPortefeuilleData(); 
            } catch (e) { hideLoading(); console.error('Erreur:', e); showToast('Erreur: ' + e.message, 'error'); } 
        }
        
        // ========== PAIEMENTS COURSE ==========
        function viewPayment(id) { const p = allPayments.find(x => x.id === id); if (!p) return; const driverShare = Math.round((p.amount || 0) * DRIVER_RATE), commission = Math.round((p.amount || 0) * COMMISSION_RATE); document.getElementById('paymentModalBody').innerHTML = `<div class="validation-instructions"><h4><i class="fas fa-exclamation-triangle"></i> R√©partition</h4><ol><li>Chauffeur (70%) : <strong>${driverShare.toLocaleString()} FCFA</strong></li><li>Commission (30%) : <strong>${commission.toLocaleString()} FCFA</strong></li></ol></div><div class="info-section"><h4><i class="fas fa-car"></i> Course</h4><div class="info-grid"><div class="info-item"><label>Client</label><span>${p.clientNom || 'N/A'}</span></div><div class="info-item"><label>Chauffeur</label><span>${p.chauffeurNom || 'N/A'}</span></div><div class="info-item"><label>Montant</label><span class="amount-highlight amount-credit">${(p.amount || 0).toLocaleString()} FCFA</span></div></div></div>${p.status === 'pending' ? `<button class="btn btn-success" onclick="confirmValidatePayment('${p.id}')" style="width:100%;margin-top:20px;"><i class="fas fa-check-circle"></i> Valider</button>` : ''}`; document.getElementById('paymentModal').classList.add('active'); }
        async function confirmValidatePayment(id) { const p = allPayments.find(x => x.id === id); const driverShare = Math.round(p.amount * DRIVER_RATE); if (!confirm(`Confirmer paiement ? Cr√©dit chauffeur: ${driverShare.toLocaleString()} FCFA`)) return; showLoading(); try { await db.collection('course_payments').doc(id).update({ status: 'validated', validatedAt: firebase.firestore.FieldValue.serverTimestamp() }); if (p.chauffeurId) await db.collection('drivers').doc(p.chauffeurId).update({ soldeDisponible: firebase.firestore.FieldValue.increment(driverShare) }); closeModal('paymentModal'); hideLoading(); showToast('‚úÖ Paiement valid√©!', 'success'); loadPortefeuilleData(); } catch (e) { hideLoading(); showToast('Erreur: ' + e.message, 'error'); } }
        function validatePayment(id) { viewPayment(id); }
        
        // ========== RETRAITS CHAUFFEUR - D√âBIT AUTO ==========
        function viewWithdrawal(id) { 
            const w = allWithdrawals.find(x => x.id === id); 
            if (!w) return; 
            
            document.getElementById('withdrawalModalBody').innerHTML = `
                <div class="validation-instructions" style="background: linear-gradient(135deg, #fee2e2, #fecaca); border-color: #ef4444;">
                    <h4 style="color: #991b1b;"><i class="fas fa-exclamation-triangle"></i> Proc√©dure - D√âBIT AUTOMATIQUE</h4>
                    <ol style="color: #b91c1c;">
                        <li>Effectuez le transfert de <strong>${(w.amount || 0).toLocaleString()} FCFA</strong></li>
                        <li>Vers le num√©ro <strong>${w.driverTelephone || 'N/A'}</strong> via <strong>${w.destination || 'Mobile Money'}</strong></li>
                        <li>Cliquez sur Confirmer pour <strong style="color:#dc2626;">D√âBITER automatiquement</strong> le solde du chauffeur</li>
                    </ol>
                </div>
                
                <div class="info-section">
                    <h4><i class="fas fa-user-tie"></i> Chauffeur</h4>
                    <div class="info-grid">
                        <div class="info-item"><label>Nom</label><span>${w.driverNom || 'N/A'}</span></div>
                        <div class="info-item"><label>T√©l√©phone</label><span>${w.driverTelephone || 'N/A'}</span></div>
                        <div class="info-item"><label>Destination</label><span>${w.destination || 'Mobile Money'}</span></div>
                        <div class="info-item"><label>Driver ID</label><span style="font-size:0.65em;word-break:break-all;">${w.driverId || '‚ö†Ô∏è MANQUANT'}</span></div>
                    </div>
                </div>
                
                <div class="info-section" style="background:#fee2e2;">
                    <h4 style="color:#dc2626;"><i class="fas fa-minus-circle"></i> Montant √† D√©biter</h4>
                    <div style="text-align:center;padding:15px;">
                        <span style="font-size:2.5em;font-weight:bold;color:#dc2626;">-${(w.amount||0).toLocaleString()} FCFA</span>
                    </div>
                </div>
                
                ${!w.driverId ? `<div class="alert-box danger"><i class="fas fa-exclamation-triangle"></i><div><strong>‚ö†Ô∏è ATTENTION</strong><p>driverId manquant - Impossible de d√©biter automatiquement. Ajoutez le driverId dans Firebase Console.</p></div></div>` : ''}
                
                ${w.status === 'pending' ? `<button class="btn btn-danger" onclick="confirmValidateWithdrawal('${w.id}')" style="width:100%;margin-top:20px;" ${!w.driverId ? 'disabled' : ''}><i class="fas fa-check-circle"></i> Confirmer le Transfert et D√©biter le Solde</button>` : `<div class="alert-box info" style="margin-top:20px;"><i class="fas fa-check-circle"></i><div><strong>D√©j√† effectu√©</strong><p>Valid√© le ${w.completedAt ? formatDate(w.completedAt) : 'N/A'}</p></div></div>`}
            `; 
            document.getElementById('withdrawalModal').classList.add('active'); 
        }
        
        async function confirmValidateWithdrawal(id) { 
            const w = allWithdrawals.find(x => x.id === id); 
            if (!w) { showToast('Retrait non trouv√©', 'error'); return; }
            if (!w.driverId) { showToast('‚ö†Ô∏è Impossible de d√©biter: driverId manquant', 'error'); return; }
            if (!confirm(`Confirmer le transfert de ${w.amount.toLocaleString()} FCFA vers ${w.driverTelephone} ?\n\n‚ö†Ô∏è Le solde du chauffeur sera D√âBIT√â automatiquement.`)) return; 
            
            showLoading('Validation et d√©bit du solde...'); 
            try { 
                const batch = db.batch();
                batch.update(db.collection('withdrawals').doc(id), { status: 'completed', completedAt: firebase.firestore.FieldValue.serverTimestamp(), validatedBy: 'admin' });
                batch.update(db.collection('drivers').doc(w.driverId), { soldeDisponible: firebase.firestore.FieldValue.increment(-w.amount) });
                await batch.commit();
                console.log(`‚úÖ Retrait valid√©: -${w.amount} FCFA pour ${w.driverId}`);
                closeModal('withdrawalModal'); hideLoading(); 
                showToast(`‚úÖ Retrait de ${w.amount.toLocaleString()} FCFA valid√© et d√©bit√©!`, 'success'); 
                loadPortefeuilleData(); 
            } catch (e) { hideLoading(); console.error('Erreur:', e); showToast('Erreur: ' + e.message, 'error'); } 
        }
        
        function validateWithdrawal(id) { viewWithdrawal(id); }

        // ========== GPS ==========
        function log(msg, type = 'info') { const t = new Date().toLocaleTimeString(); const d = document.getElementById('debugConsole'); const l = document.createElement('div'); l.style.color = { error: '#f00', success: '#0f0', warning: '#ff0', info: '#0ff' }[type] || '#0ff'; l.textContent = `[${t}] ${msg}`; d.appendChild(l); d.scrollTop = d.scrollHeight; }
        function showGPSLoader() { document.getElementById('gpsLoadingOverlay').style.display = 'flex'; }
        function hideGPSLoader() { document.getElementById('gpsLoadingOverlay').style.display = 'none'; }
        function updateGPSProgress(msg) { document.getElementById('gpsLoadingProgress').textContent = msg; }
        function updateStatus(msg, error = false) { const bar = document.getElementById('statusBar'); bar.innerHTML = msg; bar.className = 'status-bar ' + (error ? 'error' : 'connected'); }
        document.getElementById('debugBtn').addEventListener('click', () => document.getElementById('debugConsole').classList.toggle('visible'));
        function initGoogleMaps() { log('Init Google Maps...'); updateGPSProgress('Chargement carte...'); const s = document.createElement('script'); s.src = 'https://maps.googleapis.com/maps/api/js?key=AIzaSyBI1svukv3Ts7fN97ke5OGfwo2V-vRUGHI&callback=initMap'; s.async = true; s.onerror = () => { log('√âchec Maps', 'error'); hideGPSLoader(); }; document.head.appendChild(s); }
        window.initMap = function() { if (mapInitialized) { hideGPSLoader(); loadSessions(); return; } try { map = new google.maps.Map(document.getElementById('map'), { center: { lat: 14.6937, lng: -17.4441 }, zoom: 12, mapTypeControl: true, streetViewControl: false }); mapInitialized = true; log('Carte OK', 'success'); updateStatus('‚úÖ Carte charg√©e'); updateGPSProgress('Chargement chauffeurs...'); loadGPSDrivers().then(() => { updateGPSProgress('Chargement sessions...'); return loadSessions(); }).then(() => hideGPSLoader()).catch(e => { log('Erreur: ' + e.message, 'error'); hideGPSLoader(); }); } catch (e) { log('Erreur init: ' + e.message, 'error'); hideGPSLoader(); } };
        async function loadGPSDrivers() { try { const snap = await db.collection('drivers').get(); const sel = document.getElementById('filterDriver'); sel.innerHTML = '<option value="">Tous</option>'; snap.forEach(doc => { const d = doc.data(); const name = `${d.prenom || ''} ${d.nom || ''}`.trim() || d.telephone; allDriversGPS[doc.id] = name; const opt = document.createElement('option'); opt.value = doc.id; opt.textContent = name; sel.appendChild(opt); }); log(`${snap.size} chauffeurs GPS`, 'success'); } catch (e) { log('Erreur chauffeurs: ' + e.message, 'error'); } }
        async function loadSessions() { if (!isAuth) return; log('Chargement sessions...'); try { let q = db.collection('tracking_sessions'); const dF = document.getElementById('filterDriver').value, sF = document.getElementById('filterStatus').value; if (dF) q = q.where('driverId', '==', dF); if (sF) q = q.where('status', '==', sF); const snap = await q.limit(100).get(); allSessions = []; let totalDist = 0, totalPos = 0, activeCount = 0; snap.forEach(doc => { const d = doc.data(); allSessions.push({ id: doc.id, ...d }); if (d.status === 'active') activeCount++; if (d.totalDistance) totalDist += d.totalDistance; if (d.totalPositions) totalPos += d.totalPositions; }); allSessions.sort((a, b) => (b.startTime?.toDate?.() || new Date(0)) - (a.startTime?.toDate?.() || new Date(0))); document.getElementById('totalSessions').textContent = allSessions.length; document.getElementById('activeSessions').textContent = activeCount; document.getElementById('totalDistance').textContent = totalDist.toFixed(1); document.getElementById('totalPositions').textContent = totalPos; displaySessions(); log(`${allSessions.length} sessions`, 'success'); updateStatus(`‚úÖ ${allSessions.length} session(s)`); } catch (e) { log('Erreur sessions: ' + e.message, 'error'); updateStatus('‚ùå Erreur', true); } }
        function displaySessions() { const c = document.getElementById('sessionsList'); if (!allSessions.length) { c.innerHTML = '<div class="empty-state"><i class="fas fa-route"></i><p>Aucune session</p></div>'; return; } c.innerHTML = ''; allSessions.forEach(s => { const card = document.createElement('div'); card.className = 'session-card' + (currentSessionId === s.id ? ' active' : ''); const name = allDriversGPS[s.driverId] || s.driverId; const st = s.startTime?.toDate?.(); const et = s.endTime?.toDate?.(); let dur = 'En cours'; if (st && et) dur = Math.round((et - st) / 60000) + ' min'; card.innerHTML = `<div class="session-driver">${name}</div><div class="session-info"><div><i class="fas fa-clock"></i> ${st ? st.toLocaleString('fr-FR') : 'N/A'}</div><div><i class="fas fa-hourglass"></i> ${dur}</div><div><i class="fas fa-route"></i> ${(s.totalDistance || 0).toFixed(1)} km ‚Ä¢ ${s.totalPositions || 0} pts</div></div>`; card.addEventListener('click', () => selectSession(s)); c.appendChild(card); }); }
        async function selectSession(session) { log(`Selection: ${session.id}`); currentSessionId = session.id; displaySessions(); showLoading('Chargement positions...'); try { const snap = await db.collection('position_history').where('sessionId', '==', session.id).get(); const temp = []; snap.forEach(doc => { const d = doc.data(); if (d.position?.latitude && d.position?.longitude) temp.push({ lat: d.position.latitude, lng: d.position.longitude, ts: d.timestamp?.toDate?.() || new Date(0) }); }); temp.sort((a, b) => a.ts - b.ts); currentPositions = temp.map(p => ({ lat: p.lat, lng: p.lng })); if (currentPositions.length > 0) drawTrajectory(); else { hideLoading(); showToast('Aucune position', 'warning'); } } catch (e) { log('Erreur: ' + e.message, 'error'); hideLoading(); showToast('Erreur: ' + e.message, 'error'); } }
        function drawTrajectory() { markers.forEach(m => m.setMap(null)); polylines.forEach(p => p.setMap(null)); markers = []; polylines = []; const line = new google.maps.Polyline({ path: currentPositions, geodesic: true, strokeColor: '#00A854', strokeOpacity: 1, strokeWeight: 5, map: map }); polylines.push(line); const start = new google.maps.Marker({ position: currentPositions[0], map: map, label: { text: 'D', color: 'white', fontWeight: 'bold' }, icon: { path: google.maps.SymbolPath.CIRCLE, scale: 15, fillColor: '#4CAF50', fillOpacity: 1, strokeColor: 'white', strokeWeight: 3 } }); markers.push(start); const end = new google.maps.Marker({ position: currentPositions[currentPositions.length - 1], map: map, label: { text: 'A', color: 'white', fontWeight: 'bold' }, icon: { path: google.maps.SymbolPath.CIRCLE, scale: 15, fillColor: '#E30613', fillOpacity: 1, strokeColor: 'white', strokeWeight: 3 } }); markers.push(end); const bounds = new google.maps.LatLngBounds(); currentPositions.forEach(pos => bounds.extend(pos)); map.fitBounds(bounds, { padding: 50 }); showTrajectoryInfo(); hideLoading(); log('Trajet affich√©!', 'success'); }
        function showTrajectoryInfo() { const info = document.getElementById('trajectoryInfo'); info.classList.add('visible'); if (!currentPositions.length) return; let totalDist = 0; for (let i = 1; i < currentPositions.length; i++) totalDist += calcDist(currentPositions[i-1].lat, currentPositions[i-1].lng, currentPositions[i].lat, currentPositions[i].lng); const dur = Math.round((currentPositions.length * 10) / 60); const avg = dur > 0 ? (totalDist / (dur / 60)) : 0; document.getElementById('trajDistance').textContent = totalDist.toFixed(2) + ' km'; document.getElementById('trajDuration').textContent = dur + ' min'; document.getElementById('trajSpeed').textContent = Math.round(avg) + ' km/h'; document.getElementById('trajPoints').textContent = currentPositions.length; }
        function calcDist(lat1, lng1, lat2, lng2) { const R = 6371, dLat = (lat2 - lat1) * Math.PI / 180, dLng = (lng2 - lng1) * Math.PI / 180; const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLng/2) * Math.sin(dLng/2); return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); }
        function toggleMarkers() { const show = document.getElementById('showMarkers').checked; markers.forEach(m => m.setVisible(show)); }
        function toggleTrajectory() { const show = document.getElementById('showTrajectory').checked; polylines.forEach(p => p.setVisible(show)); }
        function centerOnTrajectory() { if (!currentPositions.length) return; const bounds = new google.maps.LatLngBounds(); currentPositions.forEach(pos => bounds.extend(pos)); map.fitBounds(bounds, { padding: 50 }); }
        function clearMapDisplay() { markers.forEach(m => m.setMap(null)); polylines.forEach(p => p.setMap(null)); markers = []; polylines = []; currentPositions = []; currentSessionId = null; document.getElementById('trajectoryInfo').classList.remove('visible'); displaySessions(); }
        document.getElementById('btnRefresh').addEventListener('click', function() { this.innerHTML = '<i class="fas fa-sync-alt fa-spin"></i>'; this.disabled = true; loadSessions().finally(() => { this.innerHTML = '<i class="fas fa-sync-alt"></i> Actualiser'; this.disabled = false; }); });
        document.getElementById('filterDriver').addEventListener('change', loadSessions);
        document.getElementById('filterStatus').addEventListener('change', loadSessions);
        function openImageViewer(url) { document.getElementById('viewerImage').src = url; document.getElementById('imageViewer').classList.add('active'); }
        function closeImageViewer() { document.getElementById('imageViewer').classList.remove('active'); }

        console.log('%cüöï Al Bourakh Admin v6.1 - D√©bit/Cr√©dit Auto', 'color: #00A854; font-size: 16px; font-weight: bold');
    </script>
</body>
</html>
